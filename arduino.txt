#include <WiFi.h>
#include <HTTPClient.h>
#include <ArduinoJson.h>

const char* ssid = "POCO X3 Pro";
const char* password = "Coracaodamorena";
const char* url = "https://tcc-api-ezzp.onrender.com/estado-led";

// Portas novas:
const int LED_A = 25;  // pino 1 do LED bicolor
const int LED_B = 26;  // pino 2 do LED bicolor
const int BUZZER = 27;

void setup() {
  Serial.begin(115200);
  pinMode(LED_A, OUTPUT);
  pinMode(LED_B, OUTPUT);
  pinMode(BUZZER, OUTPUT);

  Serial.println("Conectando ao WiFi...");
  WiFi.begin(ssid, password);

  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\nWiFi conectado!");
  Serial.println(WiFi.localIP());
}

void tocarBuzzerMax() {
  // Toca no mÃ¡ximo (ligado direto, sem PWM = 100% duty)
  digitalWrite(BUZZER, HIGH);
}

void pararBuzzer() {
  digitalWrite(BUZZER, LOW);
}

void ligarLED() {
  // Exemplo: acender a cor 1 (GPIO 25 = HIGH, 26 = LOW)
  digitalWrite(LED_A, HIGH);
  digitalWrite(LED_B, LOW);
}

void desligarLED() {
  digitalWrite(LED_A, LOW);
  digitalWrite(LED_B, LOW);
}

void loop() {
  if (WiFi.status() == WL_CONNECTED) {
    HTTPClient http;
    http.begin(url);
    int httpCode = http.GET();

    if (httpCode > 0) {
      String payload = http.getString();
      Serial.print("Resposta da API: ");
      Serial.println(payload);

      StaticJsonDocument<200> doc;
      if (deserializeJson(doc, payload) == DeserializationError::Ok) {
        const char* estado = doc["led"];

        if (estado && strcmp(estado, "sim") == 0) {
          if (digitalRead(LED_A) == LOW && digitalRead(LED_B) == LOW) {
            // SÃ³ avisa e toca se estava desligado antes
            Serial.println("ðŸš¨ ALARME ATIVO â†’ LED ON + BUZZER TOCANDO!");
            ligarLED();
            tocarBuzzerMax();
            delay(2000); // toca 2s no mÃ¡ximo
            pararBuzzer();
          } else {
            // Continua LED ligado sem buzzer repetir
            ligarLED();
          }
        } else {
          desligarLED();
          pararBuzzer();
          Serial.println("LED OFF");
        }

      } else {
        Serial.println("Erro ao ler JSON!");
      }
    } else {
      Serial.print("Erro HTTP: ");
      Serial.println(httpCode);
    }

    http.end();
    http.end();
  } else {
    Serial.println("WiFi desconectado, tentando reconectar...");
    WiFi.reconnect();
  }

  delay(5000);  // consulta a cada 5s de verdade
}
